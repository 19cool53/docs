<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Tasmota open source firmware for ESP8266 documentation and help"><link href=https://tasmota.github.io/docs/MQTT-Overviev/ rel=canonical><link rel="shortcut icon" href=../_media/favicon.ico><meta name=generator content="mkdocs-1.1, mkdocs-material-5.0.0rc4"><title>MQTT Overviev - Tasmota</title><link rel=stylesheet href=../assets/stylesheets/main.c1451e9e.min.css><link rel=stylesheet href=../assets/stylesheets/palette.4444686e.min.css><meta name=theme-color content=#2196f3><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Barlow:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Barlow",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style><link rel=stylesheet href=../assets/css/anchor-fix.css><link rel="preconnect dns-prefetch" href=https://www.google-analytics.com><script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-140681905-2","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script><script async src=https://www.google-analytics.com/analytics.js></script></head> <body dir=ltr data-md-color-primary=blue data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#mqtt-message-flow class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://tasmota.github.io/docs/ title=Tasmota class="md-header-nav__button md-logo" aria-label=Tasmota> <img src=../_media/logo.svg alt=logo> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z /></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> Tasmota </span> <span class="md-header-nav__topic md-ellipsis"> MQTT Overviev </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z /></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Type to start searching </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/arendst/tasmota/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class="md-tabs__link md-tabs__link--active"> Home </a> </li> <li class=md-tabs__item> <a href=../Scripting-Language/ class=md-tabs__link> Features </a> </li> <li class=md-tabs__item> <a href=../Integrations/ class=md-tabs__link> Smart Home Integrations </a> </li> <li class=md-tabs__item> <a href=../Supported-Peripherals/ class=md-tabs__link> Peripherals </a> </li> <li class=md-tabs__item> <a href=../Configuration-Procedure-for-New-Devices/ class=md-tabs__link> Supported Devices </a> </li> <li class=md-tabs__item> <a href=../FAQ/ class=md-tabs__link> Help </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://tasmota.github.io/docs/ title=Tasmota class="md-nav__button md-logo" aria-label=Tasmota> <img src=../_media/logo.svg alt=logo> </a> Tasmota </label> <div class=md-nav__source> <a href=https://github.com/arendst/tasmota/ title="Go to repository" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> arendst/tasmota </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. title=Home class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../About/ title=About class=md-nav__link> About </a> </li> <li class=md-nav__item> <a href=../Getting-Started/ title="Getting Started" class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../Upgrading/ title=Upgrading class=md-nav__link> Upgrading </a> </li> <li class=md-nav__item> <a href=../MQTT/ title=MQTT class=md-nav__link> MQTT </a> </li> <li class=md-nav__item> <a href=../Commands/ title=Commands class=md-nav__link> Commands </a> </li> <li class=md-nav__item> <a href=../Templates/ title=Templates class=md-nav__link> Templates </a> </li> <li class=md-nav__item> <a href=../Components/ title=Components class=md-nav__link> Components </a> </li> <li class=md-nav__item> <a href=../Modules/ title=Modules class=md-nav__link> Modules </a> </li> <li class=md-nav__item> <a href=../Rules/ title=Rules class=md-nav__link> Rules </a> </li> <li class=md-nav__item> <a href=../Timers/ title=Timers class=md-nav__link> Timers </a> </li> <li class=md-nav__item> <a href=../Lights/ title=Lights class=md-nav__link> Lights </a> </li> <li class=md-nav__item> <a href=../Blinds-and-Shutters/ title="Blinds and Shutters" class=md-nav__link> Blinds and Shutters </a> </li> <li class=md-nav__item> <a href=../Peripherals/ title=Peripherals class=md-nav__link> Peripherals </a> </li> <li class=md-nav__item> <a href=../Buttons-and-Switches/ title="Buttons and Switches" class=md-nav__link> Buttons and Switches </a> </li> <li class=md-nav__item> <a href=../Tasmota-IR/ title="IR Communication" class=md-nav__link> IR Communication </a> </li> <li class=md-nav__item> <a href=../TuyaMCU/ title=TuyaMCU class=md-nav__link> TuyaMCU </a> </li> <li class=md-nav__item> <a href=../WebUI/ title=WebUI class=md-nav__link> WebUI </a> </li> <li class=md-nav__item> <a href=../Compile-your-build/ title=Compiling class=md-nav__link> Compiling </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-20 type=checkbox id=nav-20> <label class=md-nav__link for=nav-20> Features <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z /></svg> </span> </label> <nav class=md-nav aria-label=Features data-md-level=1> <label class=md-nav__title for=nav-20> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </span> Features </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Scripting-Language/ title=Scripting class=md-nav__link> Scripting </a> </li> <li class=md-nav__item> <a href=../Bluetooth/ title=Bluetooth class=md-nav__link> Bluetooth </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-20-3 type=checkbox id=nav-20-3> <label class=md-nav__link for=nav-20-3> Zigbee <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z /></svg> </span> </label> <nav class=md-nav aria-label=Zigbee data-md-level=2> <label class=md-nav__title for=nav-20-3> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </span> Zigbee </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Zigbee/ title=Zigbee class=md-nav__link> Zigbee </a> </li> <li class=md-nav__item> <a href=../Zigbee-Internals/ title="Zigbee internals" class=md-nav__link> Zigbee internals </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../GPS-NTP-server/ title="GPS NTP server" class=md-nav__link> GPS NTP server </a> </li> <li class=md-nav__item> <a href=../I2CDevices/ title="I2C Devices" class=md-nav__link> I2C Devices </a> </li> <li class=md-nav__item> <a href=../TasmotaSlave/ title=TasmotaSlave class=md-nav__link> TasmotaSlave </a> </li> <li class=md-nav__item> <a href=../Device-Groups/ title="Device Groups" class=md-nav__link> Device Groups </a> </li> <li class=md-nav__item> <a href=../DeepSleep/ title=DeepSleep class=md-nav__link> DeepSleep </a> </li> <li class=md-nav__item> <a href=../PWM-dimmer-switch/ title="PWM Dimmer" class=md-nav__link> PWM Dimmer </a> </li> <li class=md-nav__item> <a href=../Buzzer/ title=Buzzer class=md-nav__link> Buzzer </a> </li> <li class=md-nav__item> <a href=../Dynamic-Sleep/ title="Dynamic Sleep" class=md-nav__link> Dynamic Sleep </a> </li> <li class=md-nav__item> <a href=../Smart-Meter-Interface/ title="Smart Meter Interface" class=md-nav__link> Smart Meter Interface </a> </li> <li class=md-nav__item> <a href=../PIR-Motion-Sensors/ title="PIR Motion Sensors" class=md-nav__link> PIR Motion Sensors </a> </li> <li class=md-nav__item> <a href=../Power-Monitoring-Calibration/ title="Power Monitoring Calibration" class=md-nav__link> Power Monitoring Calibration </a> </li> <li class=md-nav__item> <a href=../Subscribe-%26-Unsubscribe/ title="Subscribe & Unsubscribe" class=md-nav__link> Subscribe & Unsubscribe </a> </li> <li class=md-nav__item> <a href=../TLS/ title="SSL/TLS on Tasmota" class=md-nav__link> SSL/TLS on Tasmota </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-21 type=checkbox id=nav-21> <label class=md-nav__link for=nav-21> Smart Home Integrations <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z /></svg> </span> </label> <nav class=md-nav aria-label="Smart Home Integrations" data-md-level=1> <label class=md-nav__title for=nav-21> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </span> Smart Home Integrations </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Integrations/ title=Introduction class=md-nav__link> Introduction </a> </li> <li class=md-nav__item> <a href=../Alexa/ title=Alexa class=md-nav__link> Alexa </a> </li> <li class=md-nav__item> <a href=../AWS-IoT/ title="AWS IoT" class=md-nav__link> AWS IoT </a> </li> <li class=md-nav__item> <a href=../Domoticz/ title=Domoticz class=md-nav__link> Domoticz </a> </li> <li class=md-nav__item> <a href=../Home-Assistant/ title="Home Assistant" class=md-nav__link> Home Assistant </a> </li> <li class=md-nav__item> <a href=../Homebridge/ title=Homebridge class=md-nav__link> Homebridge </a> </li> <li class=md-nav__item> <a href=../HomeSeer/ title=HomeSeer class=md-nav__link> HomeSeer </a> </li> <li class=md-nav__item> <a href=../IP-Symcon/ title="IP Symcon" class=md-nav__link> IP Symcon </a> </li> <li class=md-nav__item> <a href=../KNX/ title=KNX class=md-nav__link> KNX </a> </li> <li class=md-nav__item> <a href=../NodeRed/ title=NodeRed class=md-nav__link> NodeRed </a> </li> <li class=md-nav__item> <a href=../nymea/ title=nymea class=md-nav__link> nymea </a> </li> <li class=md-nav__item> <a href=../Octoprint/ title=OctoPrint class=md-nav__link> OctoPrint </a> </li> <li class=md-nav__item> <a href=../openHAB/ title=openHAB class=md-nav__link> openHAB </a> </li> <li class=md-nav__item> <a href=../otto/ title=Otto class=md-nav__link> Otto </a> </li> <li class=md-nav__item> <a href=https://github.com/arendst/Tasmota/issues/3769 title=IOBroker class=md-nav__link> IOBroker </a> </li> <li class=md-nav__item> <a href=https://github.com/tim-hellhake/tasmota-adapter title="Mozilla WebThings Adapter" class=md-nav__link> Mozilla WebThings Adapter </a> </li> <li class=md-nav__item> <a href=https://github.com/BrettSheleski/SmartThingsPublic/tree/master/devicetypes/brettsheleski/sonoff-tasmota.src title=SmartThings class=md-nav__link> SmartThings </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-22 type=checkbox id=nav-22> <label class=md-nav__link for=nav-22> Peripherals <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z /></svg> </span> </label> <nav class=md-nav aria-label=Peripherals data-md-level=1> <label class=md-nav__title for=nav-22> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </span> Peripherals </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Supported-Peripherals/ title="Supported Peripherals" class=md-nav__link> Supported Peripherals </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-22-2 type=checkbox id=nav-22-2> <label class=md-nav__link for=nav-22-2> Displays <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z /></svg> </span> </label> <nav class=md-nav aria-label=Displays data-md-level=2> <label class=md-nav__title for=nav-22-2> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </span> Displays </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Displays/ title=Displays class=md-nav__link> Displays </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ADC/ title="Analog pin" class=md-nav__link> Analog pin </a> </li> <li class=md-nav__item> <a href=../A4988-Stepper-Motor-Controller/ title="A4988 stepper motor controller" class=md-nav__link> A4988 stepper motor controller </a> </li> <li class=md-nav__item> <a href=../AM2301/ title="AM2301 temperature and humidity sensor" class=md-nav__link> AM2301 temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../APDS-9960/ title="APDS-9960 light and gesture sensor" class=md-nav__link> APDS-9960 light and gesture sensor </a> </li> <li class=md-nav__item> <a href=../AZ-7798/ title="AZ7798 CO2 meter" class=md-nav__link> AZ7798 CO<sub>2</sub> meter </a> </li> <li class=md-nav__item> <a href=../BH1750/ title="BH1750 ambient light sensor" class=md-nav__link> BH1750 ambient light sensor </a> </li> <li class=md-nav__item> <a href=../BME280/ title="BME280 temperature, humidity and pressure sensor" class=md-nav__link> BME280 temperature, humidity and pressure sensor </a> </li> <li class=md-nav__item> <a href=../BME680/ title="BME680 temperature, humidity, pressure and gas sensor" class=md-nav__link> BME680 temperature, humidity, pressure and gas sensor </a> </li> <li class=md-nav__item> <a href=../CC2530/ title="CC2530 Zigbee module" class=md-nav__link> CC2530 Zigbee module </a> </li> <li class=md-nav__item> <a href=../Moisture-Sensor-and-Chirp%21-Sensor/ title="Chirp! moisture sensor" class=md-nav__link> Chirp! moisture sensor </a> </li> <li class=md-nav__item> <a href=../DHT11/ title="DHT11 temperature and humidity sensor" class=md-nav__link> DHT11 temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../DS18x20/ title="DS18x20 temperature sensor" class=md-nav__link> DS18x20 temperature sensor </a> </li> <li class=md-nav__item> <a href=../DS3231/ title="DS3231 Real Time Clock" class=md-nav__link> DS3231 Real Time Clock </a> </li> <li class=md-nav__item> <a href=../HM-10/ title="HM-10 Bluetooth module" class=md-nav__link> HM-10 Bluetooth module </a> </li> <li class=md-nav__item> <a href=../HM-17/ title="HM-17 Bluetooth module" class=md-nav__link> HM-17 Bluetooth module </a> </li> <li class=md-nav__item> <a href=../HC-SR04/ title="HC-SR04 ultrasonic ranging sensor" class=md-nav__link> HC-SR04 ultrasonic ranging sensor </a> </li> <li class=md-nav__item> <a href=../Honeywell-HIH/ title="Honeywell HIH temperature and humidity sensor" class=md-nav__link> Honeywell HIH temperature and humidity sensor </a> </li> <li class=md-nav__item> <a href=../IR-Remote/ title="IR Remote" class=md-nav__link> IR Remote </a> </li> <li class=md-nav__item> <a href=../LM75AD/ title="LM75AD temperature sensor" class=md-nav__link> LM75AD temperature sensor </a> </li> <li class=md-nav__item> <a href=../MCP230xx/ title="MCP23008 / MCP23017 GPIO Expander" class=md-nav__link> MCP23008 / MCP23017 GPIO Expander </a> </li> <li class=md-nav__item> <a href=../MGC3130/ title="MGC3130 3D tracking and gesture controller" class=md-nav__link> MGC3130 3D tracking and gesture controller </a> </li> <li class=md-nav__item> <a href=../MH-Z19B/ title="MH-Z19B CO2 Sensor" class=md-nav__link> MH-Z19B CO<sub>2</sub> Sensor </a> </li> <li class=md-nav__item> <a href=../MLX90614/ title="MLX90614 infrared thermometer" class=md-nav__link> MLX90614 infrared thermometer </a> </li> <li class=md-nav__item> <a href=../MPR121/ title="MPR121 capacitive touch sensor" class=md-nav__link> MPR121 capacitive touch sensor </a> </li> <li class=md-nav__item> <a href=../MPU-6050/ title="MPU-6050 gyroscope and accelerometer" class=md-nav__link> MPU-6050 gyroscope and accelerometer </a> </li> <li class=md-nav__item> <a href=../NRF24L01/ title="NRF24L01 Bluetooth module" class=md-nav__link> NRF24L01 Bluetooth module </a> </li> <li class=md-nav__item> <a href=../P1-Smart-Meter/ title="Kaifa MA105C Energy Meter" class=md-nav__link> Kaifa MA105C Energy Meter </a> </li> <li class=md-nav__item> <a href=../PAJ7620/ title="PAJ7620U2 gesture sensor" class=md-nav__link> PAJ7620U2 gesture sensor </a> </li> <li class=md-nav__item> <a href=../PCA9685/ title="PCA9685 12-bit PWM controller" class=md-nav__link> PCA9685 12-bit PWM controller </a> </li> <li class=md-nav__item> <a href=../PN532/ title="PN532 NFC reader" class=md-nav__link> PN532 NFC reader </a> </li> <li class=md-nav__item> <a href=../PZEM-0XX/ title="PZEM-0xx power monitor" class=md-nav__link> PZEM-0xx power monitor </a> </li> <li class=md-nav__item> <a href=../RCWL-0516/ title="RCWL-0516 microwave radar motion sensor" class=md-nav__link> RCWL-0516 microwave radar motion sensor </a> </li> <li class=md-nav__item> <a href=../RDM6300/ title="RDM6300 RFID reader" class=md-nav__link> RDM6300 RFID reader </a> </li> <li class=md-nav__item> <a href=../SDS011/ title="SDS011 air quality sensor" class=md-nav__link> SDS011 air quality sensor </a> </li> <li class=md-nav__item> <a href=../SHT30/ title="SHT30 temperature sensor" class=md-nav__link> SHT30 temperature sensor </a> </li> <li class=md-nav__item> <a href=../TX2x/ title="TX20/TX23 anemometer" class=md-nav__link> TX20/TX23 anemometer </a> </li> <li class=md-nav__item> <a href=../TSL2561/ title="TSL2561 light sensor" class=md-nav__link> TSL2561 light sensor </a> </li> <li class=md-nav__item> <a href=../VEML6070/ title="VEML6070 UV light sensor" class=md-nav__link> VEML6070 UV light sensor </a> </li> <li class=md-nav__item> <a href=../VL53L0x/ title="VL53L0X laser ranging module" class=md-nav__link> VL53L0X laser ranging module </a> </li> <li class=md-nav__item> <a href=../WS2812B-RGB-Shield/ title="WS2812B RGB Shield" class=md-nav__link> WS2812B RGB Shield </a> </li> <li class=md-nav__item> <a href=../WS2812B-and-WS2813/ title="WS2812B and WS2813" class=md-nav__link> WS2812B and WS2813 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-23 type=checkbox id=nav-23> <label class=md-nav__link for=nav-23> Supported Devices <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z /></svg> </span> </label> <nav class=md-nav aria-label="Supported Devices" data-md-level=1> <label class=md-nav__title for=nav-23> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </span> Supported Devices </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Configuration-Procedure-for-New-Devices/ title="Configuring unknown devices" class=md-nav__link> Configuring unknown devices </a> </li> <li class=md-nav__item> <a href="https://templates.blakadder.com/ " target='_blank""' title="All Supported Devices" class=md-nav__link> All Supported Devices </a> </li> <li class=md-nav__item> <a href=../Supported-Modules/ title="Supported Modules" class=md-nav__link> Supported Modules </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-24 type=checkbox id=nav-24> <label class=md-nav__link for=nav-24> Help <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z /></svg> </span> </label> <nav class=md-nav aria-label=Help data-md-level=1> <label class=md-nav__title for=nav-24> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </span> Help </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../FAQ/ title=FAQ class=md-nav__link> FAQ </a> </li> <li class=md-nav__item> <a href=../Troubleshooting/ title=Troubleshooting class=md-nav__link> Troubleshooting </a> </li> <li class=md-nav__item> <a href=../Device-Recovery/ title="Device Recovery" class=md-nav__link> Device Recovery </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Contributing/ title=Contributing class=md-nav__link> Contributing </a> </li> <li class=md-nav__item> <a href="//discord.gg/Ks2Kzd4  " target='_blank""' title="Discord Community" class=md-nav__link> Discord Community </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d=M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z /></svg> </span> Table of contents </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#mqtt-message-flow class=md-nav__link> MQTT Message flow </a> <nav class=md-nav aria-label="MQTT Message flow"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mqtt-message-prefixes class=md-nav__link> MQTT Message Prefixes </a> </li> <li class=md-nav__item> <a href=#configuring-mqtt class=md-nav__link> Configuring MQTT </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#programming-examples-for-the-sonoff-mqtt-ota-arduino class=md-nav__link> Programming examples for the Sonoff-MQTT-OTA-Arduino </a> <nav class=md-nav aria-label="Programming examples for the Sonoff-MQTT-OTA-Arduino"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tldr class=md-nav__link> TL;DR </a> </li> <li class=md-nav__item> <a href=#general class=md-nav__link> General </a> </li> <li class=md-nav__item> <a href=#linuxcygwin-command-line class=md-nav__link> Linux/Cygwin command line </a> </li> <li class=md-nav__item> <a href=#python class=md-nav__link> Python </a> </li> <li class=md-nav__item> <a href=#javascript class=md-nav__link> JavaScript </a> </li> <li class=md-nav__item> <a href=#android-phone-mqtt-dashboard class=md-nav__link> Android phone MQTT Dashboard </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#troubleshooting class=md-nav__link> Troubleshooting </a> <nav class=md-nav aria-label=Troubleshooting> <ul class=md-nav__list> <li class=md-nav__item> <a href=#connect-failed class=md-nav__link> CONNECT FAILED </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#status-codes class=md-nav__link> Status codes </a> </li> <li class=md-nav__item> <a href=#debug-tools class=md-nav__link> Debug Tools </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/tasmota/docs/blob/master/docs/MQTT-Overviev.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/></svg> </a> <h1>MQTT Overviev</h1> <h2 id=mqtt-message-flow>MQTT Message flow<a class=headerlink href=#mqtt-message-flow title="Permanent link">~</a></h2> <p>Here is a diagram showing the connection phase and the network transactions required to turn a sonoff device on. </p> <p><img alt="flow diagram" src=http://alt2.pbeirne.com/images/sonoff_cmnd_flow3.png></p> <p>In a typical setup, you'll have multiple devices on the left-hand side. </p> <p><img alt=image src=http://alt2.pbeirne.com/images/sonoff_cmnd_flow2.png></p> <p>There are lots of ways to control your devices. One typically uses a laptop/desktop to configure and test your Sonoffs and perhaps a smartphone to keep track of what's happening. In the long run you might want to integrate your device in a home-automation system like node-RED, openHAB, HomeAssistant, HomeBridge, Domoticz, ...</p> <h3 id=mqtt-message-prefixes>MQTT Message Prefixes<a class=headerlink href=#mqtt-message-prefixes title="Permanent link">~</a></h3> <table> <thead> <tr> <th align=left>Message</th> <th align=left>Issued by</th> <th align=left>Intent</th> </tr> </thead> <tbody> <tr> <td align=left><code>cmnd</code></td> <td align=left>devices shown on the right-hand side</td> <td align=left>control the Sonoff; set configuration; ask for status</td> </tr> <tr> <td align=left><code>stat</code></td> <td align=left>the Sonoffs on the left-hand side</td> <td align=left>report back status or configuration message</td> </tr> <tr> <td align=left><code>tele</code></td> <td align=left>some Sonoffs (like temperature measuring devices)</td> <td align=left>report unsolicited telemetry info at periodic intervals</td> </tr> </tbody> </table> <p>These are <code>prefix1</code>, <code>prefix2</code> &amp; <code>prefix3</code> in the code</p> <h3 id=configuring-mqtt>Configuring MQTT<a class=headerlink href=#configuring-mqtt title="Permanent link">~</a></h3> <p>MQTT settings can be initially setup in the web interface and thereafter configured by commands.</p> <h4>Enable MQTT</h4> <p>Enable MQTT with the tickbox under Configuration -&gt; Configuration Other</p> <h4>Configure MQTT Settings</h4> <p>Once enabled MQTT can be configured at Configuration -&gt; Configure MQTT. </p> <table> <thead> <tr> <th align=left>Field</th> <th align=left>Size</th> <th align=left>Default(my_user_config.h)</th> <th align=left>Notes</th> </tr> </thead> <tbody> <tr> <td align=left>Host name</td> <td align=left>32</td> <td align=left>MQTT_HOST=mqtt_broker.com</td> <td align=left>Remote URL or ip address. Note that without a special firmware build SSL is NOT supported.</td> </tr> <tr> <td align=left>Port</td> <td align=left>uint</td> <td align=left>MQTT_PORT=1883</td> <td align=left>0-65535</td> </tr> <tr> <td align=left>Client Id</td> <td align=left>32</td> <td align=left>MQTT_CLIENT_ID=DVES_%06X</td> <td align=left>FallBack topic of this device, will be unique for every device; logged by the MQTT server</td> </tr> <tr> <td align=left>Username</td> <td align=left>32</td> <td align=left>MQTT_USER=DVES_USER</td> <td align=left>Username for MQTT server authentication</td> </tr> <tr> <td align=left>Password</td> <td align=left>32</td> <td align=left>MQTT_PASS=DVES_PASS</td> <td align=left>Password for MQTT server authentication</td> </tr> <tr> <td align=left>Topic</td> <td align=left>32</td> <td align=left>MQTT_TOPIC=sonoff</td> <td align=left>User friendly topic name; usually describes the location or use of this device; used in the MQTT commands and responses; should be unique</td> </tr> <tr> <td align=left>Full Topic</td> <td align=left>100</td> <td align=left>%prefix%/%topic%</td> <td align=left>Format string used to assemble the MQTT commands</td> </tr> </tbody> </table> <p>Note: By default firmware will search for an MQTT broker using mDNS by searching for a tcp record mqtt.local. However the use of local mDNS hostnames (ex: mqtt_home.local) is not supported, if you want to use a broker on your local network you need to use its local IP or rely on a local DNS to resolve the hostnames.</p> <h2 id=programming-examples-for-the-sonoff-mqtt-ota-arduino>Programming examples for the Sonoff-MQTT-OTA-Arduino<a class=headerlink href=#programming-examples-for-the-sonoff-mqtt-ota-arduino title="Permanent link">~</a></h2> <h3 id=tldr>TL;DR<a class=headerlink href=#tldr title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_sub -h mqtt_server_name.com -t stat/my_sonoff/POWER -v    # listen for status</span>
<span class=err>mosquitto_pub -h mqtt_server_name.com -t cmnd/my_sonoff/power -m 1  # turn on the light</span>
</code></pre></div> <h3 id=general>General<a class=headerlink href=#general title="Permanent link">~</a></h3> <p>See the wiki's <a href=../Commands/ >command list</a> for the definitive list of operations that you can perform. The first word in the column marked <code>Command</code> is the text that you need to put at the end of a <code>cmnd</code> string when you issue a publication message. The second word is the contents of the payload. If there is no second word, you can simply send an empty payload. For example:</p> <table> <thead> <tr> <th align=left>Command</th> <th align=left>Description</th> </tr> </thead> <tbody> <tr> <td align=left>Power</td> <td align=left>Show current power state as On or Off</td> </tr> <tr> <td align=left>Power on</td> <td align=left>Turn power On</td> </tr> <tr> <td align=left>Power off</td> <td align=left>Turn power Off</td> </tr> </tbody> </table> <p>To execute these, issue (publish) these MQTT requests</p> <div class=codehilite><pre><span></span><code><span class=err>MQTT topic            MQTT payload</span>
<span class=err>cmnd/my_device/power  &lt;empty&gt;</span>
<span class=err>cmnd/my_device/power  on</span>
<span class=err>cmnd/my_device/power  off</span>
</code></pre></div> <p>The sonoff will respond with these publications:</p> <div class=codehilite><pre><span></span><code><span class=err>MQTT topic            MQTT payload</span>
<span class=err>stat/my_device/POWER  ON</span>
<span class=err>stat/my_device/POWER  ON</span>
<span class=err>stat/my_device/POWER  OFF</span>
</code></pre></div> <p>If you have subscribed to these <code>stat</code> messages, you can be informed of changes on the device.</p> <h4>Connecting to MQTT</h4> <p>You'll need an MQTT server somewhere to communicate with your Sonoff. Some people use publicly available servers, such as iot.eclipse.org. <a href=http://moxd.io/2015/10/public-mqtt-brokers/ >List of brokers</a></p> <p>Other people think the MQTT server should reside inside your private LAN. You could use a Raspberry/Orange Pi, or just about any Linux machine as the server/broker; you might even squeeze it into your router if you're using OpenWRT.</p> <h4>Topics</h4> <p>The middle word of the 'topic' phrase indicates the name of the device. You can communicate with a sonoff using its topic name, its group name or its FallBack topic name (like DVES_123456).</p> <p>At the time the sonoff connects with the MQTT server, the sonoff subscribes to +++"cmnd/my-topic/#", "cmnd/group-topic/#" and "cmnd/fallback-topic/#",+++ and listens on all those names. You can find the group name using "status 0" and the FallBack topic using "status 6" or both on the Information page in WebUI.</p> <h4>Creating your own MQTT server/broker</h4> <p>See these sites: - <a href=https://www.digitalocean.com/community/questions/how-to-setup-a-mosquitto-mqtt-server-and-receive-data-from-owntracks>Rufio howto</a> - <a href=http://wingsquare.com/blog/setting-up-mqtt-mosquitto-broker-in-ubuntu-linux/ >Wingsquare howto</a> - <a href=http://www.instructables.com/id/Installing-MQTT-BrokerMosquitto-on-Raspberry-Pi/ >Instructables howto on Raspberry Pi</a></p> <h3 id=linuxcygwin-command-line>Linux/Cygwin command line<a class=headerlink href=#linuxcygwin-command-line title="Permanent link">~</a></h3> <p>You can install the mosquitto client system using either - [Cygwin] setup mosquitto_client - [Ubuntu/Debian] apt install mosquitto_client - [Centos/Fedora] yum install mosquitto_client</p> <h4>Controlling (Publishing)</h4> <p>You can control the relay in your Sonoff with mosquitto_pub. Suppose your Sonoff topic is "my_house_living_room" and your mqtt broker is "control_central". To turn on the Sonoff, type this on the command line:</p> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_pub -h control_central -t cmnd/my_house_living_room/power -m 1</span>
</code></pre></div> <p>You can turn the Sonoff back off again with:</p> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_pub -h control_central -t cmnd/my_house_living_room/power -m 0</span>
</code></pre></div> <p>If you want to find out what state your sonoff is, issue this command with an empty payload to trigger a status response (see below for how to listen):</p> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_pub -h control_central -t cmnd/my_house_living_room/status -n</span>
</code></pre></div> <h4>Listening (Subscribing)</h4> <p>To keep track of your sonoff, just subscribe to messages starting with <code>stat</code>, followed by your topic. For example, to pick up status messages from your sonoff, use</p> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_sub -h control_central -t stat/my_house_living_room/STATUS -v</span>
</code></pre></div> <p>The optional <code>-v</code> will show you the topic <em>and</em> payload.</p> <p>These Sonoffs can provide specific information if you wish. To just monitor the relay state, try</p> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_sub -h control_central -t stat/my_house_living_room/POWER</span>
</code></pre></div> <p>You can also use wildcards in your subscription. To pick up <em>every</em> message from this sonoff, you can use</p> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_sub -h control_central -t stat/my_house_living_room/+</span>
</code></pre></div> <p>and then some other code to just pick out the messages you want. If you have a collection of sonoffs, you can listen to them all by either using the group topic</p> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_sub -h control_central -t stat/my_house_collection/POWER</span>
</code></pre></div> <p>or by using a wildcard in the 2nd position</p> <div class=codehilite><pre><span></span><code><span class=err>mosquitto_sub -h control_central -t stat/+/POWER</span>
</code></pre></div> <h3 id=python>Python<a class=headerlink href=#python title="Permanent link">~</a></h3> <p>Of course you can always call <code>system()</code> or <code>subprocess()</code> to run the <code>mosquitto_pub</code> and <code>mosquitto_sub</code> command lines as shown above. But if you wish, you can install the paho-mqtt package and communicate with MQTT using Python objects.</p> <p>Let's turn the lights on, wait a few seconds, turn them off, check the status and wait for a time stamp</p> <div class=codehilite><pre><span></span><code><span class=kn>import</span> <span class=nn>paho.mqtt.client</span> <span class=k>as</span> <span class=nn>mqtt</span><span class=o>,</span> <span class=nn>time</span><span class=o>,</span> <span class=nn>sys</span>

<span class=n>last_topic</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
<span class=n>last_payload</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>

<span class=c1># main</span>
<span class=k>def</span> <span class=nf>on_connect</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>userdata</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>rc</span><span class=p>):</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Connected&quot;</span><span class=p>)</span>
    <span class=n>client</span><span class=o>.</span><span class=n>is_connected</span> <span class=o>=</span> <span class=kc>True</span>

<span class=k>def</span> <span class=nf>on_message</span><span class=p>(</span><span class=n>client</span><span class=p>,</span> <span class=n>userdata</span><span class=p>,</span> <span class=n>message</span><span class=p>):</span>
    <span class=sd>&#39;&#39;&#39; note: message is a tuple of (topic, payload, qos, retain)&#39;&#39;&#39;</span>
    <span class=k>global</span> <span class=n>last_topic</span><span class=p>,</span> <span class=n>last_payload</span>
    <span class=n>last_topic</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>topic</span>
    <span class=n>last_payload</span> <span class=o>=</span> <span class=n>message</span><span class=o>.</span><span class=n>payload</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Got a message with topic: [&quot;</span> <span class=o>+</span> <span class=n>last_topic</span> <span class=o>+</span> <span class=s2>&quot;] and payload [&quot;</span> <span class=o>+</span> <span class=n>last_payload</span> <span class=o>+</span> <span class=s2>&quot;]&quot;</span><span class=p>)</span>

<span class=n>client</span> <span class=o>=</span> <span class=n>mqtt</span><span class=o>.</span><span class=n>Client</span><span class=p>()</span>
<span class=c1># if you need a username and/or password for mqtt uncomment next line</span>
<span class=c1># client.username_pw_set(&quot;myusr&quot;, password=&quot;mypwd&quot;) </span>
<span class=n>client</span><span class=o>.</span><span class=n>on_connect</span> <span class=o>=</span> <span class=n>on_connect</span>
<span class=n>client</span><span class=o>.</span><span class=n>on_message</span> <span class=o>=</span> <span class=n>on_message</span>

<span class=n>client</span><span class=o>.</span><span class=n>is_connected</span> <span class=o>=</span> <span class=kc>False</span>
<span class=n>client</span><span class=o>.</span><span class=n>loop_start</span><span class=p>()</span>
<span class=n>client</span><span class=o>.</span><span class=n>connect</span><span class=p>(</span><span class=s2>&quot;control_central&quot;</span><span class=p>)</span> <span class=c1># replace &quot;control_central&quot; with ip address or name of server</span>

<span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span>
<span class=k>if</span> <span class=ow>not</span> <span class=n>client</span><span class=o>.</span><span class=n>is_connected</span><span class=p>:</span>
    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;problem connecting to the MQTT server; please check your settings&quot;</span><span class=p>)</span>
    <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>

<span class=c1># edit subscribe and publish lines and use yours like &quot;stat/tasmota/POWER&quot;</span>
<span class=n>client</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&quot;stat/my_house_living_room/POWER&quot;</span><span class=p>)</span>
<span class=n>client</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s2>&quot;cmnd/my_house_living_room/power&quot;</span><span class=p>,</span><span class=s2>&quot;1&quot;</span><span class=p>)</span>

<span class=c1># wait a little bit</span>
<span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>15</span><span class=p>)</span>
<span class=n>client</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s2>&quot;cmnd/my_house_living_room/power&quot;</span><span class=p>,</span><span class=s2>&quot;0&quot;</span><span class=p>)</span>

<span class=c1># ask for system status</span>
<span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
<span class=n>client</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&quot;stat/my_house_living_room/STATUS&quot;</span><span class=p>)</span>
<span class=n>client</span><span class=o>.</span><span class=n>publish</span><span class=p>(</span><span class=s2>&quot;cmnd/my_house_living_room/status&quot;</span><span class=p>,</span><span class=kc>None</span><span class=p>)</span>

<span class=c1># now wait for a time stamp from the sonoff; this could take an hour</span>
<span class=n>client</span><span class=o>.</span><span class=n>subscribe</span><span class=p>(</span><span class=s2>&quot;tele/my_house_living_room/+&quot;</span><span class=p>)</span>

<span class=c1># if using tasmota-sensors.bin next section will not work unless you replace &quot;STATE&quot; with &quot;SENSOR&quot;</span>
<span class=k>while</span> <span class=mi>1</span><span class=p>:</span>
    <span class=k>if</span> <span class=n>last_topic</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;tele/&quot;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>last_topic</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s2>&quot;STATE&quot;</span><span class=p>):</span>
        <span class=n>locate_time</span> <span class=o>=</span> <span class=n>last_payload</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=sa>b</span><span class=s1>&#39;&quot;Time&quot;:&#39;</span><span class=p>)</span>
        <span class=n>the_time</span> <span class=o>=</span> <span class=n>last_payload</span><span class=p>[</span><span class=n>locate_time</span><span class=o>+</span><span class=mi>8</span><span class=p>:</span><span class=n>locate_time</span><span class=o>+</span><span class=mi>8</span><span class=o>+</span><span class=mi>19</span><span class=p>]</span>
        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;the sonoff thinks the time is: &quot;</span><span class=o>+</span><span class=n>the_time</span><span class=o>.</span><span class=n>decode</span><span class=p>(</span><span class=s2>&quot;utf-8&quot;</span><span class=p>))</span>
        <span class=k>break</span>
    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>

<span class=n>client</span><span class=o>.</span><span class=n>loop_stop</span><span class=p>()</span>
<span class=n>client</span><span class=o>.</span><span class=n>disconnect</span><span class=p>()</span>
</code></pre></div> <p>Ref: <a href=https://pypi.python.org/pypi/paho-mqtt/1.1>Python MQTT</a></p> <h3 id=javascript>JavaScript<a class=headerlink href=#javascript title="Permanent link">~</a></h3> <p>Using the node module MQTT.js you can connect to the MQTT broker, send messages and listen to topics. The example uses code compatible with Node v4 or later.</p> <div class=codehilite><pre><span></span><code><span class=s1>&#39;use strict&#39;</span><span class=p>;</span>
<span class=kr>const</span> <span class=nx>mqtt</span>   <span class=o>=</span> <span class=nx>require</span><span class=p>(</span><span class=s1>&#39;mqtt&#39;</span><span class=p>);</span>

<span class=kr>const</span> <span class=nx>broker</span> <span class=o>=</span> <span class=s1>&#39;mqtt://192.168.0.13&#39;</span><span class=p>;</span>   <span class=c1>// MQTT Broker hostname/IP address</span>
<span class=kr>const</span> <span class=nx>client</span> <span class=o>=</span> <span class=nx>mqtt</span><span class=p>.</span><span class=nx>connect</span><span class=p>(</span><span class=nx>broker</span><span class=p>);</span>    <span class=c1>// MQTT Client</span>
<span class=kr>const</span> <span class=nx>device</span> <span class=o>=</span> <span class=s1>&#39;switch1&#39;</span><span class=p>;</span>               <span class=c1>// Sonoff device identifier</span>

<span class=kd>let</span> <span class=nx>state</span> <span class=o>=</span> <span class=s1>&#39;OFF&#39;</span><span class=p>;</span>
<span class=kd>let</span> <span class=nx>timer</span><span class=p>;</span>

<span class=nx>client</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;connect&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>()</span> <span class=p>{</span>

    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=si>}</span><span class=sb> Client connected to </span><span class=si>${</span><span class=nx>broker</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>

    <span class=nx>client</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(</span><span class=sb>`stat/</span><span class=si>${</span><span class=nx>device</span><span class=si>}</span><span class=sb>/+`</span><span class=p>);</span>
    <span class=nx>client</span><span class=p>.</span><span class=nx>subscribe</span><span class=p>(</span><span class=sb>`tele/</span><span class=si>${</span><span class=nx>device</span><span class=si>}</span><span class=sb>/+`</span><span class=p>);</span>

    <span class=nx>client</span><span class=p>.</span><span class=nx>publish</span><span class=p>(</span><span class=sb>`cmnd/</span><span class=si>${</span><span class=nx>device</span><span class=si>}</span><span class=sb>/status`</span><span class=p>);</span>

    <span class=nx>timer</span> <span class=o>=</span> <span class=nx>setInterval</span><span class=p>(</span><span class=nx>loop</span><span class=p>,</span> <span class=mi>2000</span><span class=p>);</span>
<span class=p>});</span>

<span class=nx>client</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>topic</span><span class=p>,</span> <span class=nx>message</span><span class=p>)</span> <span class=p>{</span>

    <span class=k>if</span> <span class=p>(</span><span class=nx>topic</span> <span class=o>===</span> <span class=sb>`stat/</span><span class=si>${</span><span class=nx>device</span><span class=si>}</span><span class=sb>/POWER`</span><span class=p>)</span> <span class=p>{</span>
        <span class=nx>state</span> <span class=o>=</span> <span class=nx>message</span><span class=p>.</span><span class=nx>toString</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=si>}</span><span class=sb> RX </span><span class=si>${</span><span class=nx>topic</span><span class=si>}</span><span class=sb> </span><span class=si>${</span><span class=nx>message</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
<span class=p>});</span>

<span class=kd>function</span> <span class=nx>loop</span><span class=p>()</span> <span class=p>{</span>

    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>client</span><span class=p>.</span><span class=nx>connected</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nx>timer</span> <span class=o>&amp;&amp;</span> <span class=nx>timer</span><span class=p>.</span><span class=nx>clearInterval</span><span class=p>();</span>
    <span class=p>}</span>

    <span class=kd>let</span> <span class=nx>newState</span> <span class=o>=</span> <span class=nx>state</span> <span class=o>===</span> <span class=s1>&#39;OFF&#39;</span> <span class=o>?</span> <span class=s1>&#39;ON&#39;</span> <span class=o>:</span> <span class=s1>&#39;OFF&#39;</span><span class=p>;</span>

    <span class=nx>client</span><span class=p>.</span><span class=nx>publish</span><span class=p>(</span><span class=sb>`cmnd/</span><span class=si>${</span><span class=nx>device</span><span class=si>}</span><span class=sb>/power`</span><span class=p>,</span> <span class=nx>newState</span><span class=p>);</span>

    <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nb>Date</span><span class=p>.</span><span class=nx>now</span><span class=p>()</span><span class=si>}</span><span class=sb> TX cmnd/</span><span class=si>${</span><span class=nx>device</span><span class=si>}</span><span class=sb>/power </span><span class=si>${</span><span class=nx>newState</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
<span class=p>}</span>
</code></pre></div> <p>Ref: <a href=https://github.com/mqttjs/MQTT.js>Node MQTT.js</a></p> <h3 id=android-phone-mqtt-dashboard>Android phone MQTT Dashboard<a class=headerlink href=#android-phone-mqtt-dashboard title="Permanent link">~</a></h3> <p>The <a href="https://play.google.com/store/apps/details?id=com.thn.iotmqttdashboard">MQTT Dashboard</a> provides the ability to connect and control Sonoff devices directly.</p> <p>On the first page, enter the details of how your phone should connect to the MQTT broker. On the SUBSCRIBE page, you can create widgets which listen for publications from the Sonoff. A typical subscription for a power controller might be <code>stat/my_device/POWER</code></p> <p>You could also pick up <em>all</em> your devices with <code>stat/+/POWER</code></p> <p>On the PUBLISH page, you can create widgets to toggle or on/off your Sonoff. Typically you'd send a <code>cmnd/my_device/power</code> as the topic, and <code>on</code> or <code>off</code> as the <em>publish value</em>. Note that you can also have separate words on the app's user interface, such as <code>illuminated</code> and <code>extinguished</code>; these are <em>not</em> sent out via MQTT, they're just user interface.</p> <p>Alternatively, if you're using a home automation system, there may be an Andriod/iOS app to link to your home automation. That's not covered in this how-to.</p> <h2 id=troubleshooting>Troubleshooting<a class=headerlink href=#troubleshooting title="Permanent link">~</a></h2> <h3 id=connect-failed>CONNECT FAILED<a class=headerlink href=#connect-failed title="Permanent link">~</a></h3> <div class=codehilite><pre><span></span><code><span class=n>MQTT</span><span class=o>:</span> <span class=n>CONNECT</span> <span class=n>FAILED</span> <span class=n>x</span><span class=o>.</span><span class=na>x</span><span class=o>.</span><span class=na>x</span><span class=o>.</span><span class=na>x</span><span class=o>:</span><span class=n>x</span><span class=o>,</span> <span class=n>rc</span> <span class=o>{</span><span class=n>code</span><span class=o>}.</span> <span class=n>Retry</span> <span class=k>in</span> <span class=mi>10</span> <span class=n>seconds</span>
</code></pre></div> <h2 id=status-codes><a href=http://pubsubclient.knolleary.net/api.html#state>Status codes</a><a class=headerlink href=#status-codes title="Permanent link">~</a></h2> <div class=codehilite><pre><span></span><code><span class=c>-4: MQTT_CONNECTION_TIMEOUT - the server didn&#39;t respond within the keepalive time</span>
<span class=c>-3: MQTT_CONNECTION_LOST - the network connection was broken</span>
<span class=c>-2: MQTT_CONNECT_FAILED - the network connection failed</span>
<span class=c>-1: MQTT_DISCONNECTED - the client is disconnected cleanly</span>
<span class=c> 0: MQTT_CONNECTED - the client is connected</span>
<span class=c> 1: MQTT_CONNECT_BAD_PROTOCOL - the server doesn&#39;t support the requested version of MQTT</span>
<span class=c> 2: MQTT_CONNECT_BAD_CLIENT_ID - the server rejected the client identifier</span>
<span class=c> 3: MQTT_CONNECT_UNAVAILABLE - the server was unable to accept the connection</span>
<span class=c> 4: MQTT_CONNECT_BAD_CREDENTIALS - the username/password were rejected</span>
<span class=c> 5: MQTT_CONNECT_UNAUTHORIZED - the client was not authorized to connect</span>
</code></pre></div> <h2 id=debug-tools>Debug Tools<a class=headerlink href=#debug-tools title="Permanent link">~</a></h2> <ul> <li><a href="https://play.google.com/store/apps/details?id=mqttsnooper.mqttsnooper">MQTT Snooper - Sniffer App on Android</a></li> <li><a href="https://mqtt-explorer.com/?c=tasmota-wiki">MQTT Explorer - Desktop Application</a></li> <li>If mosquitto is installed, command-line: <code>mosquitto_sub -h mqtt-host -v -t "#"</code></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://discord.gg/Ks2Kzd4 target=_blank rel=noopener title=discord.gg class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M297.216 243.2c0 15.616-11.52 28.416-26.112 28.416-14.336 0-26.112-12.8-26.112-28.416s11.52-28.416 26.112-28.416c14.592 0 26.112 12.8 26.112 28.416zm-119.552-28.416c-14.592 0-26.112 12.8-26.112 28.416s11.776 28.416 26.112 28.416c14.592 0 26.112-12.8 26.112-28.416.256-15.616-11.52-28.416-26.112-28.416zM448 52.736V512c-64.494-56.994-43.868-38.128-118.784-107.776l13.568 47.36H52.48C23.552 451.584 0 428.032 0 398.848V52.736C0 23.552 23.552 0 52.48 0h343.04C424.448 0 448 23.552 448 52.736zm-72.96 242.688c0-82.432-36.864-149.248-36.864-149.248-36.864-27.648-71.936-26.88-71.936-26.88l-3.584 4.096c43.52 13.312 63.744 32.512 63.744 32.512-60.811-33.329-132.244-33.335-191.232-7.424-9.472 4.352-15.104 7.424-15.104 7.424s21.248-20.224 67.328-33.536l-2.56-3.072s-35.072-.768-71.936 26.88c0 0-36.864 66.816-36.864 149.248 0 0 21.504 37.12 78.08 38.912 0 0 9.472-11.52 17.152-21.248-32.512-9.728-44.8-30.208-44.8-30.208 3.766 2.636 9.976 6.053 10.496 6.4 43.21 24.198 104.588 32.126 159.744 8.96 8.96-3.328 18.944-8.192 29.44-15.104 0 0-12.8 20.992-46.336 30.464 7.68 9.728 16.896 20.736 16.896 20.736 56.576-1.792 78.336-38.912 78.336-38.912z"/></svg> </a> <a href=https://t.me/tasmota target=_blank rel=noopener title=t.me class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg> </a> <a href=https://github.com/tasmota target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../assets/javascripts/vendor.23350dc5.min.js></script> <script src=../assets/javascripts/bundle.36a8f969.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script> <script>
        app = initialize({
          base: "..",
          features: ["tabs"],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.3bc815f0.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>